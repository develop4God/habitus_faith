name: ðŸ—ï¸ Build Flutter APK/AAB (debug-release)

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build (default: main)'
        required: false
        default: 'main'
        type: string
      build_type:
        description: 'Build type'
        required: false
        default: 'debug'
        type: choice
        options:
          - debug
          - release
          - aab-release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“‹ Show build info
        run: |
          echo "ðŸš€ Building Flutter APK/AAB"
          echo "ðŸ“¦ Branch: ${{ github.event.inputs.branch || 'main' }}"
          echo "ðŸ”§ Build Type: ${{ github.event.inputs.build_type || 'debug' }}"
          echo "ðŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "ðŸ“… Timestamp: $(date)"

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch || 'main' }}

      - name: Patch SDK and NDK versions for CI
        run: |
          sed -i -E 's/compileSdk = (flutter\.compileSdkVersion|[0-9]+)/compileSdk = 36/' android/app/build.gradle.kts
          sed -i -E 's/targetSdk = (flutter\.targetSdkVersion|[0-9]+)/targetSdk = 36/' android/app/build.gradle.kts
          sed -i -E 's/minSdk = (flutter\.minSdkVersion|[0-9]+)/minSdk = 23/' android/app/build.gradle.kts
          # Patch ndkVersion or add it if not present
          if grep -Eq 'ndkVersion\s*=' android/app/build.gradle.kts; then
            sed -i -E 's/ndkVersion\s*=\s*"[0-9.]+"|ndkVersion\s*=\s*[0-9.]+/ndkVersion = "27.0.12077973"/' android/app/build.gradle.kts
          else
            sed -i -E '/android\s*{/{:a;N;/}/!ba;s/(android\s*{)/\1\n    ndkVersion = "27.0.12077973"/}' android/app/build.gradle.kts
          fi

      - name: Create .env file with Gemini API Key
        run: echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env

      - name: Create google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 -d > android/app/google-services.json

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ”§ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: stable
          cache: true

      - name: ðŸ“Š Flutter doctor
        run: flutter doctor -v

      - name: âš™ï¸ Configure Gradle for CI environment
        run: |
          echo "âš™ï¸ Optimizing Gradle settings for GitHub Actions (Java heap space)..."
          cat > android/gradle.properties << EOF
          org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.configureondemand=true
          android.useAndroidX=true
          android.enableJetifier=false
          android.enableR8=true
          org.gradle.caching=true
          org.gradle.vfs.watch=false
          EOF
          echo "âœ… gradle.properties for CI created:"
          cat android/gradle.properties

      - name: Create .env file with Gemini API Key
        run: echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" > .env

      - name: Create google-services.json
        run: |
          echo "${{ secrets.GOOGLE_SERVICES_JSON_B64 }}" | base64 -d > android/app/google-services.json

      - name: ðŸ§¹ Clear all caches
        run: |
          echo "ðŸ§¹ Clearing Flutter and Gradle caches..."
          rm -rf ~/.gradle/caches/
          rm -rf ~/.pub-cache/
          rm -rf build/
          rm -rf android/.gradle/
          rm -rf android/app/build/
          echo "âœ… Caches cleared"

      - name: ðŸ§¹ Sanitize branch name for artifact
        run: |
          BRANCH_NAME="${{ github.event.inputs.branch || 'main' }}"
          CLEAN_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[\/:"<>|*?\\]/-/g')
          echo "CLEAN_BRANCH_NAME=$CLEAN_BRANCH_NAME" >> $GITHUB_ENV
          echo "âœ… Original branch:  $BRANCH_NAME"
          echo "âœ… Sanitized branch: $CLEAN_BRANCH_NAME"

      - name: ðŸ› ï¸ Ensure Flutter properties are available
        run: |
          echo "ðŸ”§ Generating local.properties..."
          flutter build apk --config-only

          echo "ðŸ“‹ Verifying local.properties..."
          if [ -f "android/local.properties" ]; then
            echo "âœ… local.properties generated:"
            cat android/local.properties
          else
            echo "âš ï¸ Creating local.properties manually..."
            mkdir -p android
            cat > android/local.properties << EOF
          sdk.dir=$ANDROID_HOME
          flutter.sdk=$FLUTTER_ROOT
          EOF
            echo "âœ… Manual local.properties created:"
            cat android/local.properties
          fi
          echo "flutter.minSdkVersion=23" >> android/local.properties
          echo "flutter.compileSdkVersion=36" >> android/local.properties

      - name: ðŸ“¦ Install dependencies
        run: flutter pub get

      - name: ðŸ§¹ Clean build
        run: flutter clean

      - name: ðŸ”‘ Setup signing keystore
        if: ${{ github.event.inputs.build_type == 'aab-release' || github.event.inputs.build_type == 'release' }}
        run: |
          echo "ðŸ”‘ Configurando keystore para firmado..."
          echo "Debug:  tamaÃ±o del secreto base64:"
          echo -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | wc -c
          mkdir -p android/app/
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.p12
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=upload-keystore.p12
          EOF
          echo "âœ… Keystore configurado"
          echo "ðŸ“‹ Verificando archivos de firmado:"
          ls -la android/key.properties android/app/upload-keystore.p12

      - name: ðŸ”§ Configure build.gradle.kts for signing
        if: ${{ github.event.inputs.build_type == 'aab-release' || github.event.inputs.build_type == 'release' }}
        run: |
          echo "ðŸ”§ Verificando configuraciÃ³n de firmado en build.gradle.kts..."
          if ! grep -q "signingConfigs" android/app/build.gradle.kts; then
            echo "âš ï¸ build.gradle.kts no tiene configuraciÃ³n de firmado"
            echo "ðŸ“‹ Para firmar correctamente, asegÃºrate de tener en android/app/build.gradle.kts:"
            echo "   - signingConfigs { release { ...  } }"
            echo "   - buildTypes { release { signingConfig = signingConfigs.getByName(\"release\") } }"
          else
            echo "âœ… ConfiguraciÃ³n de firmado encontrada en build.gradle.kts"
          fi

      - name: ðŸ—ï¸ Build APK/AAB (${{ github.event.inputs.build_type || 'debug' }})
        env:
          GRADLE_OPTS: '-Dorg.gradle.jvmargs="-Xmx4096m -XX:MaxMetaspaceSize=1024m"'
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          if [ "$BUILD_TYPE" = "aab-release" ]; then
            echo "ðŸ“¦ Building release AAB (Android App Bundle) for Google Play Store..."
            flutter build appbundle --release
            APK_PATH="build/app/outputs/bundle/release/app-release.aab"
            APK_TYPE="release-aab"
          elif [ "$BUILD_TYPE" = "release" ]; then
            echo "ðŸš€ Building release APK solo para arm64-v8a..."
            flutter build apk --release --target-platform=android-arm64
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            APK_TYPE="release-apk"
          else
            echo "ðŸ”§ Building debug APK solo para arm64-v8a..."
            flutter build apk --debug --target-platform=android-arm64
            APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
            APK_TYPE="debug-apk"
          fi
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "APK_TYPE=$APK_TYPE" >> $GITHUB_ENV

      - name: ðŸ” Verify signing (for release builds)
        if: ${{ github.event.inputs.build_type == 'aab-release' || github.event.inputs.build_type == 'release' }}
        run: |
          echo "ðŸ” Verificando si el archivo estÃ¡ firmado correctamente..."
          if [ -f "$APK_PATH" ]; then
            # Para AAB files
            if [[ "$APK_PATH" == *.aab ]]; then
              echo "ðŸ“¦ Verificando AAB firmado..."
              echo "âœ… AAB generado - El firmado se verifica en el upload al Play Store"
            # Para APK files
            elif [[ "$APK_PATH" == *.apk ]]; then
              echo "ðŸ“± Verificando APK firmado..."
              if jarsigner -verify -verbose -certs "$APK_PATH"; then
                echo "âœ… APK estÃ¡ correctamente firmado"
              else
                echo "âŒ APK no estÃ¡ firmado correctamente"
                exit 1
              fi
            fi
          else
            echo "âŒ Archivo no encontrado:  $APK_PATH"
            exit 1
          fi

      - name: ðŸ“‹ APK/AAB Info
        run: |
          if [ -f "$APK_PATH" ]; then
            echo "âœ… Build completed successfully!"
            echo "ðŸ“ Path: $APK_PATH"
            echo "ðŸ“ Size: $(ls -lh $APK_PATH | awk '{print $5}')"
            echo "ðŸ” SHA256: $(sha256sum $APK_PATH | cut -d' ' -f1)"
            if [[ "$APK_PATH" == *.aab ]]; then
              echo ""
              echo "ðŸ“¦ AAB Info:"
              echo "âœ… Ready for Google Play Store upload"
              echo "ðŸ”§ This is an Android App Bundle (AAB) file"
              echo "ðŸ”‘ Signed with upload keystore"
            elif [[ "$APK_PATH" == *release.apk ]]; then
              echo ""
              echo "ðŸ“± Release APK Info:"
              echo "âœ… Signed release APK ready for distribution"
              echo "ðŸ”‘ Signed with upload keystore"
            fi
          else
            echo "âŒ Build artifact not found at expected path: $APK_PATH"
            echo "ðŸ“ Contents of build directory:"
            find build -name "*.apk" -o -name "*.aab" -type f 2>/dev/null || echo "No APK or AAB files found"
            exit 1
          fi

      - name: ðŸ“‹ Get app version
        run: |
          VERSION=$(grep "version:" pubspec.yaml | sed 's/version: //' | tr -d ' ')
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "âœ… App version:  $VERSION"

      - name: ðŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ env.APK_TYPE }}-${{ env.CLEAN_BRANCH_NAME }}-v${{ env.APP_VERSION }}-${{ github.run_number }}
          path: ${{ env.APK_PATH }}
          retention-days: 30

      - name: ðŸ“ Build Summary
        run: |
          echo "## ðŸŽ‰ Build Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**:  \`${{ github.event.inputs.branch || 'main' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type**: \`${{ env.APK_TYPE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **File Size**: \`$(ls -lh $APK_PATH | awk '{print $5}')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`$(git log -1 --oneline)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: \`#${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

          BUILD_TYPE="${{ github.event.inputs.build_type || 'debug' }}"
          if [ "$BUILD_TYPE" = "aab-release" ] || [ "$BUILD_TYPE" = "release" ]; then
            echo "- **ðŸ”‘ Signing**: \`Signed with upload keystore\`" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifact:" >> $GITHUB_STEP_SUMMARY
          echo "The build artifact is available as: \`app-${{ env.APK_TYPE }}-${{ env.CLEAN_BRANCH_NAME }}-v${{ env.APP_VERSION }}-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ env.APK_PATH }}" == *.aab ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸª Google Play Store:" >> $GITHUB_STEP_SUMMARY
            echo "âœ… This AAB file is ready to be uploaded to Google Play Store" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”‘ Properly signed with upload keystore" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“‹ Upload this file to: [Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ env.APK_PATH }}" == *release.apk ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“± Release APK:" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Signed release APK ready for distribution" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ”‘ Signed with upload keystore" >> $GITHUB_STEP_SUMMARY
          fi

  branch-comparison:
    runs-on: ubuntu-latest
    if: github.event.inputs.branch != 'main' && github.event.inputs.branch != ''

    steps:
      - name: ðŸ“¥ Checkout target branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch }}

      - name: ðŸ” Branch comparison
        run: |
          echo "## ðŸ” Branch Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TARGET_BRANCH="${{ github.event.inputs.branch }}"

          echo "### ðŸ“‹ Target Branch: \`$TARGET_BRANCH\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest commit**: \`$(git log -1 --oneline)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: \`$(git log -1 --pretty=format:'%an')\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: \`$(git log -1 --pretty=format:'%ad' --date=short)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TARGET_BRANCH" != "main" ]; then
            echo "### ðŸ”„ Comparison with main:" >> $GITHUB_STEP_SUMMARY

            git fetch origin main:main 2>/dev/null || git fetch origin main 2>/dev/null || echo "Could not fetch main branch"

            if git show-ref --verify --quiet refs/heads/main || git show-ref --verify --quiet refs/remotes/origin/main; then
              MAIN_REF=$(git show-ref --verify --quiet refs/heads/main && echo "main" || echo "origin/main")

              AHEAD=$(git rev-list --count $MAIN_REF..$TARGET_BRANCH 2>/dev/null || echo "N/A")
              BEHIND=$(git rev-list --count $TARGET_BRANCH..$MAIN_REF 2>/dev/null || echo "N/A")

              echo "- **Commits ahead of main**: $AHEAD" >> $GITHUB_STEP_SUMMARY
              echo "- **Commits behind main**: $BEHIND" >> $GITHUB_STEP_SUMMARY

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ“ Recent commits in \`$TARGET_BRANCH\`:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              git log --oneline $MAIN_REF..$TARGET_BRANCH --max-count=5 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No unique commits or comparison not possible" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸ Could not compare with main branch" >> $GITHUB_STEP_SUMMARY
            fi
          fi
